<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <title>WebSocket –ó–∞–∫–∞–∑—ã</title>
  <style>
    body {
      font-family: sans-serif;
      margin: 20px;
    }
    #orders {
      margin-top: 20px;
    }
    .order {
      border: 1px solid #ccc;
      padding: 10px;
      margin-bottom: 10px;
      border-radius: 6px;
    }
  </style>
</head>
<body>
  <h1>–ù–æ–≤—ã–µ –∑–∞–∫–∞–∑—ã —á–µ—Ä–µ–∑ WebSocket</h1>
  <div id="status">üîÑ –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ...</div>
  <div id="orders"></div>

  <script>
    const statusEl = document.getElementById("status");
    const ordersEl = document.getElementById("orders");

    const token = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJ1c2VyX2lkIjoxLCJyb2xlIjoiYWRtaW4iLCJleHAiOjE3NDcwODAxMDd9.UQE3q-bp2MAwIn6QzDDvHZAm1xvwywmdJy2rinECJ9M";

    const ordersMap = new Map();

    function renderOrder(order) {
      const existing = document.querySelector(`.order[data-id="${order.id}"]`);

      // —Å–æ—Ö—Ä–∞–Ω—è–µ–º –≤ –ø–∞–º—è—Ç—å
      ordersMap.set(order.id, order);

      const html = `
        <strong>–ó–∞–∫–∞–∑ #${order.id}</strong><br>
        –°—Ç–∞—Ç—É—Å: ${order.status || "–Ω–µ —É–∫–∞–∑–∞–Ω"}<br>
        –î–æ—Å—Ç–∞–≤–∫–∞: ${order.delivery_type || "‚Äî"}<br>
        –û–ø–ª–∞—Ç–∞: ${order.payment_type || "‚Äî"}<br>
        –°—É–º–º–∞: ${order.total}<br>
        –ò–º—è: ${order.name || "‚Äî"}<br>
        –ê–¥—Ä–µ—Å: ${order.address || "‚Äî"}<br>
        –í—Ä–µ–º—è: ${order.created_at || "‚Äî"}
      `;

      if (existing) {
        existing.innerHTML = html;
      } else {
        const div = document.createElement("div");
        div.className = "order";
        div.setAttribute("data-id", order.id);
        div.innerHTML = html;
        ordersEl.prepend(div);
      }
    }

    fetch("https://chechnya-product.ru/api/admin/orders", {
      headers: { Authorization: `Bearer ${token}` },
    })
      .then((response) => {
        if (!response.ok) throw new Error("–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –∑–∞–∫–∞–∑–æ–≤");
        return response.json();
      })
      .then((data) => {
        if (Array.isArray(data.data)) {
          data.data.reverse().forEach((order) => renderOrder(order));
        }
      })
      .catch((err) => {
        statusEl.textContent = "‚ö† –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∑–∞–∫–∞–∑–æ–≤";
        console.error("API error:", err);
      });

    const socket = new WebSocket("wss://chechnya-product.ru/ws/orders");

    socket.onopen = () => {
      statusEl.textContent = "‚úÖ –ü–æ–¥–∫–ª—é—á–µ–Ω–æ –∫ WebSocket";
    };

    socket.onclose = () => {
      statusEl.textContent = "‚ùå –°–æ–µ–¥–∏–Ω–µ–Ω–∏–µ –∑–∞–∫—Ä—ã—Ç–æ";
    };

    socket.onerror = (err) => {
      statusEl.textContent = "‚ö† –û—à–∏–±–∫–∞ WebSocket";
      console.error("WebSocket error:", err);
    };

    socket.onmessage = (event) => {
      try {
        const message = JSON.parse(event.data);
        if (message.type === "new_order" || message.type === "status_update") {
          const newOrder = message.order;
          const existing = ordersMap.get(newOrder.id);
          const mergedOrder = { ...(existing || {}), ...newOrder };
          renderOrder(mergedOrder);
        }
      } catch (e) {
        console.error("–û—à–∏–±–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏—è:", e);
      }
    };
  </script>
</body>
</html>
